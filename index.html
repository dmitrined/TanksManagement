<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wein-Tank-Management (Lokal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      // УДАЛЕНО: Firebase Imports
      
      // Глобальные переменные для доступа в скрипте ниже
      window.firebase = {}; // Оставляем пустой объект для совместимости
    </script>

    <style>
      /* Стиль для шрифта Inter */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }

      /* Основной контейнер плана - адаптивная сетка */
      #plan-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        width: 95%;
        max-width: 1200px;
        margin: 20px auto;
        border: 1px solid #d1d5db;
        background-color: #fff;
        padding: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-radius: 12px;
      }

      /* Стиль для отдельной бочки/емкости */
      .tank {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 60px;
        color: #fff;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        padding: 5px;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
      }

      .tank:hover {
        opacity: 0.9;
        transform: scale(1.03);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }

      /* Цветовая кодировка */
      .tank-full {
        background-color: #dc2626; /* Красный: Gefüllt */
      }
      .tank-empty {
        background-color: #10b981; /* Зеленый: Leer */
      }
      .tank-reserved {
        background-color: #f59e0b; /* Желтый: Reserviert */
        color: #1f2937; /* Темный текст для контраста */
        text-shadow: none;
      }
      .tank-to-be-emptied {
        background-color: #3b82f6; /* Синий: Wird Leer */
      }
      /* Стиль для ошибки в инпуте конфигурации */
      .config-error {
        background-color: #fef2f2 !important;
        border-color: #fca5a5 !important;
        color: #ef4444 !important;
      }
    </style>
  </head>
  <body class="p-4">
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Wein-Tank-Management</h1>

      <div
        class="flex flex-col sm:flex-row justify-center items-center mt-2 space-y-2 sm:space-y-0 sm:space-x-4"
      >
        <p id="auth-status" class="text-sm text-gray-600">
          Status: Lokaler Speicher (localStorage)
        </p>
        <button
          onclick="openConfigModal()"
          class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-lg font-semibold hover:bg-indigo-600 transition duration-150 shadow-md"
        >
          Tank-Konfiguration
        </button>
      </div>

      <p class="text-xs text-gray-500 mt-3">
        <span class="text-green-600 font-bold">Grün</span>: Leer |
        <span class="text-red-600 font-bold">Rot</span>: Gefüllt |
        <span class="text-yellow-600 font-bold">Gelb</span>: Reserviert |
        <span class="text-blue-600 font-bold">Blau</span>: Wird Leer. Zum
        Verwalten antippen.
      </p>
    </header>

    <div id="filter-controls" class="text-center mb-6">
      <button
        id="filter-all"
        onclick="filterTanks('all')"
        class="filter-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg mr-2 transition duration-150 shadow-md"
      >
        Alle Tanks
      </button>
      <button
        id="filter-empty"
        onclick="filterTanks('empty')"
        class="filter-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mr-2 transition duration-150 shadow-md"
      >
        Leere Tanks (Grün/Blau)
      </button>
      <button
        id="filter-full"
        onclick="filterTanks('full')"
        class="filter-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md"
      >
        Gefüllte Tanks (Rot/Gelb)
      </button>
    </div>

    <div id="plan-container">
      </div>

    <div
      id="modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50"
    >
      <div
        id="modal-container"
        class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all"
      >
        <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
        <div id="modal-content">
          </div>
        <div id="modal-footer" class="mt-6 text-right">
          </div>
      </div>
    </div>

    <div
      id="message-box"
      class="fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50 transition-transform transform translate-x-full hidden"
    ></div>

    <script>
      // Глобальные переменные
      window.tanksData = {};
      window.tanksConfig = [];

      window.currentTankId = null;
      window.currentFilter = "all";

      // Ключи для localStorage
      const CONFIG_STORAGE_KEY = "WINE_TANK_CONFIG_V1";
      const DATA_STORAGE_KEY = "WINE_TANK_DATA_V1";
      // УДАЛЕНО: Переменные Firebase

      // --- Утилиты Firebase и Инициализация ---
      // УДАЛЕНО: Код для получения appId и firebaseConfig

      /** Инициализация Firebase и Аутентификация (Обновлено для локального режима) */
      async function setupFirebaseAndAuth() {
        // В локальном режиме просто загружаем данные
        initializeStorageAndDisplay();
      }

      // --- ЛОКАЛЬНЫЕ CRUD Операции (ЗАМЕНА Firestore) ---

      /** Загружает Tank Config из localStorage */
      function loadConfigFromLocalStorage() {
        try {
          const storedConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
          if (storedConfig) {
            window.tanksConfig = JSON.parse(storedConfig);
          } else {
            // Если данных нет, используем конфигурацию по умолчанию и сразу сохраняем
            window.tanksConfig = generateDefaultConfig();
            saveConfigToLocalStorage(window.tanksConfig);
          }
        } catch (e) {
          console.error("Fehler beim Laden der Konfiguration aus localStorage:", e);
          window.tanksConfig = generateDefaultConfig();
        }
      }

      /** Загружает Tank Data из localStorage */
      function loadDataFromLocalStorage() {
        try {
          const storedData = localStorage.getItem(DATA_STORAGE_KEY);
          if (storedData) {
            window.tanksData = JSON.parse(storedData);
          } else {
            window.tanksData = {};
          }
        } catch (e) {
          console.error("Fehler beim Laden der Tank-Daten aus localStorage:", e);
          window.tanksData = {};
        }
      }

      /** Сохраняет текущий Tank Config в localStorage */
      async function saveConfigToLocalStorage(configToSave) {
        try {
          localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(configToSave));
          return true;
        } catch (error) {
          console.error("Fehler beim Speichern der Konfiguration in localStorage:", error);
          window.showMessage(
            "Speichern der Konfiguration fehlgeschlagen!",
            "error"
          );
          return false;
        }
      }

      /** Сохраняет текущие динамические данные Tank'ов в localStorage */
      async function saveTankDataToLocalStorage(dataToSave) {
        try {
          localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(dataToSave));
          return true;
        } catch (error) {
          console.error("Fehler beim Speichern der Tank-Daten in localStorage:", error);
          window.showMessage(
            "Speichern der Tank-Daten fehlgeschlagen!",
            "error"
          );
          return false;
        }
      }

      // --- Утилиты для Конфигурации (unchanged) ---

      /** Генерирует 0 Tank'ов по умолчанию */
      function generateDefaultConfig() {
        const defaultConfig = [];
        for (let i = 1; i <= 6; i++) { // Установлено 6 таков по умолчанию, чтобы было что-то видно
          defaultConfig.push({
            position: i.toString(),
            id: i.toString(),
            volume: "1000L",
          });
        }
        // Сохраняем как резервную копию в localStorage (уже не резервная, а основная)
        try {
          localStorage.setItem(
            CONFIG_STORAGE_KEY,
            JSON.stringify(defaultConfig)
          );
        } catch (e) {
          console.warn("localStorage Speicherung fehlgeschlagen.");
        }
        return defaultConfig;
      }

      /** Возвращает объект конфигурации Tank'а по его Tank-ID */
      function getTankConfigById(id) {
        return window.tanksConfig.find((c) => c.id === id);
      }

      /** Показывает сообщение на экране вместо alert() */
      window.showMessage = function (message, type = "success") {
        const box = document.getElementById("message-box");
        box.textContent = message;
        box.classList.remove(
          "hidden",
          "bg-green-500",
          "bg-red-500",
          "bg-blue-500",
          "bg-yellow-500",
          "bg-orange-500"
        );

        let bgColor = "bg-green-500";
        if (type === "error") bgColor = "bg-red-500";
        else if (type === "info") bgColor = "bg-blue-500";
        else if (type === "warning") bgColor = "bg-orange-500";

        box.classList.add(bgColor);

        box.classList.remove("translate-x-full");

        setTimeout(() => {
          box.classList.add("translate-x-full");
          setTimeout(() => box.classList.add("hidden"), 300);
        }, 3000);
      };

      /** Инициализация хранилища: подписка на данные Firestore (ЗАМЕНЕНО на локальную загрузку) */
      function initializeStorageAndDisplay() {
        loadConfigFromLocalStorage();
        loadDataFromLocalStorage();
        
        // После загрузки данных синхронизируем данные (чтобы новые танки из конфига были в данных)
        syncDataWithConfig();
        
        renderInitialPlan();
        updateTankDisplay();
      }
      
      /** Синхронизация данных: удаляет старые данные и добавляет новые танки */
      function syncDataWithConfig() {
          const newTankData = {};
          
          window.tanksConfig.forEach(config => {
              const id = config.id;
              // Если данные для танка уже существуют, используем их
              if (window.tanksData[id]) {
                  newTankData[id] = window.tanksData[id];
              } else {
                  // Иначе создаем новый (статус 'empty')
                  newTankData[id] = {
                      id: id,
                      status: "empty",
                      wineDetails: null,
                  };
              }
          });
          
          window.tanksData = newTankData;
          // Сохраняем обновленные данные локально
          saveTankDataToLocalStorage(window.tanksData);
      }


      // --- Логика Модального окна (Общая) ---

      /** Закрывает модальное окно */
      window.closeModal = function () {
        document.getElementById("modal").classList.add("hidden");
        document.getElementById("modal").classList.remove("flex");

        const configForm = document.getElementById("config-form");
        if (configForm) configForm.remove();

        window.currentTankId = null;
      };

      /** Открывает модальное окно */
      function openGenericModal(title, contentHtml, footerHtml) {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-content").innerHTML = contentHtml;
        document.getElementById("modal-footer").innerHTML = footerHtml;
        document.getElementById("modal").classList.remove("hidden");
        document.getElementById("modal").classList.add("flex");

        if (title.startsWith("Tank Nr.")) {
          document
            .getElementById("modal-container")
            .classList.remove("max-w-4xl");
          document.getElementById("modal-container").classList.add("max-w-md");
        } else if (title === "Tank-Konfiguration") {
          document
            .getElementById("modal-container")
            .classList.remove("max-w-md");
          document.getElementById("modal-container").classList.add("max-w-4xl");
        }
      }

      // --- Логика Tank Configuration (Обновлено для localStorage) ---

      /** Открывает модальное окно для конфигурации Tank'ов */
      window.openConfigModal = function () {
        // Важно: работаем с копией, чтобы изменения не влияли на основную переменную до сохранения
        const currentConfigCopy = JSON.parse(
          JSON.stringify(window.tanksConfig)
        );

        let tableRows = "";

        currentConfigCopy.forEach((item, index) => {
          // position - это порядковый номер в массиве, используем его как Row ID для DOM
          // Используем config.position для Row ID, но обновляем отображаемую Pos.
          tableRows += `
                    <tr id="config-row-${item.position}" data-original-id="${
            item.id
          }" class="hover:bg-gray-50 border-t">
                        <td class="px-2 py-2 text-sm text-gray-500">${
                          index + 1
                        }</td>
                        <td class="px-2 py-2">
                            <input type="text" name="id_${
                              item.position
                            }" value="${item.id}" required 
                                   class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm focus:ring-indigo-500 focus:border-indigo-500 font-semibold" 
                                   pattern="[A-Za-z0-9-]+" title="Nur Buchstaben, Zahlen und Bindestriche erlaubt">
                        </td>
                        <td class="px-2 py-2">
                            <input type="text" name="volume_${
                              item.position
                            }" value="${item.volume}" required 
                                   class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </td>
                        <td class="px-2 py-2 text-center w-1/12">
                            <button type="button" onclick="deleteTankRow('${
                              item.position
                            }')" title="Tank löschen" 
                                    class="text-red-500 hover:text-red-700 transition duration-150 p-1">
                                <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
        });

        const contentHtml = `
                <form id="config-form" onsubmit="event.preventDefault(); saveConfigChanges(event)" class="space-y-4">
                    <p class="text-sm text-gray-600">Bearbeiten Sie die ID (Tank Nr.) und das Volumen für jede Tank-Position. Speichern Sie, um die Änderungen zu übernehmen.</p>
                    <div class="overflow-y-auto max-h-[60vh] border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Pos.</th>
                                    <th class="px-2 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12">Tank ID / Nr.</th>
                                    <th class="px-2 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">Volumen</th>
                                    <th class="px-2 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="config-table-body" class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    <button type="button" onclick="addTankToConfigModal()" class="mt-4 px-3 py-1 bg-green-500 text-white text-sm rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow-md">
                        + Tank hinzufügen
                    </button>
                </form>
            `;

        const footerHtml = `
                <button type="submit" form="config-form" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 mr-2">Konfiguration speichern</button>
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Abbrechen</button>
            `;

        openGenericModal("Tank-Konfiguration", contentHtml, footerHtml);
      };

      /** Удаляет строку Tank'а из модального окна конфигурации (перед сохранением) */
      window.deleteTankRow = function (position) {
        const row = document.getElementById(`config-row-${position}`);
        if (row) {
          row.remove();
          // Пересчитываем номера позиций в первой колонке
          const tbody = document.getElementById("config-table-body");
          for (let i = 0; i < tbody.rows.length; i++) {
            tbody.rows[i].cells[0].textContent = (i + 1).toString();
          }
          window.showMessage(
            `Tank-Position ${position} zur Löschung vorgemerkt. Speichern, um zu bestätigen.`,
            "warning"
          );
        }
      };

      /** Добавляет новую строку для Tank'а в модальное окно конфигурации */
      window.addTankToConfigModal = function () {
        const tbody = document.getElementById("config-table-body");
        if (!tbody) return;

        // Используем уникальный временный ID для новой строки
        const newPosition = "new_" + Date.now();
        const newDisplayPosition = tbody.rows.length + 1;
        const newId = newDisplayPosition.toString();
        const newVolume = "0"; //  дефолтное значение

        const tr = document.createElement("tr");
        tr.id = `config-row-${newPosition}`;
        tr.className = "hover:bg-gray-50 border-t";
        tr.innerHTML = `
                <td class="px-2 py-2 text-sm text-gray-500">${newDisplayPosition}</td>
                <td class="px-2 py-2">
                    <input type="text" name="id_${newPosition}" value="${newId}" required 
                           class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm focus:ring-indigo-500 focus:border-indigo-500 font-semibold" 
                           pattern="[A-Za-z0-9-]+" title="Nur Buchstaben, Zahlen und Bindestriche erlaubt">
                </td>
                <td class="px-2 py-2">
                    <input type="text" name="volume_${newPosition}" value="${newVolume}" required 
                           class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </td>
                <td class="px-2 py-2 text-center w-1/12">
                    <button type="button" onclick="deleteTankRow('${newPosition}')" title="Tank löschen" 
                            class="text-red-500 hover:text-red-700 transition duration-150 p-1">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>
            `;
        tbody.appendChild(tr);

        tr.scrollIntoView({ behavior: "smooth", block: "end" });
      };

      /** ОБНОВЛЕНО: Сохраняет изменения конфигурации и отправляет их в localStorage */
      window.saveConfigChanges = async function (event) {
        const tbody = document.getElementById("config-table-body");
        if (!tbody) {
          window.showMessage(
            "Konfigurationsformular fehlt.",
            "error"
          );
          return;
        }

        const newConfig = [];
        const newIds = [];
        let hasError = false;

        // 1. Сбор и валидация данных из формы
        for (let i = 0; i < tbody.rows.length; i++) {
          const row = tbody.rows[i];
          const idInput = row.cells[1].querySelector("input");
          const volumeInput = row.cells[2].querySelector("input");

          const position = (i + 1).toString();
          const newId = idInput.value.trim();
          const newVolume = volumeInput.value.trim();

          // Сброс ошибок
          idInput.classList.remove("config-error");
          volumeInput.classList.remove("config-error");

          if (newId === "" || newVolume === "") {
            window.showMessage(
              `Fehler: ID und Volumen dürfen nicht leer sein (Pos. ${position}).`,
              "error"
            );
            idInput.classList.add("config-error");
            volumeInput.classList.add("config-error");
            hasError = true;
            break;
          }
          if (newIds.includes(newId)) {
            window.showMessage(
              `Fehler: Die Tank ID "${newId}" ist dupliziert.`,
              "error"
            );
            idInput.classList.add("config-error");
            hasError = true;
            break;
          }
          newIds.push(newId);

          newConfig.push({
            position: position,
            id: newId,
            volume: newVolume,
          });
        }

        if (hasError) return;

        // 2. Обновление глобального конфига и данных
        window.tanksConfig = newConfig;

        // 3. Слияние (Merge) с текущим состоянием данных (tanksData)
        // syncDataWithConfig позаботится о синхронизации и сохранении данных
        syncDataWithConfig();

        // 4. Локальное сохранение
        const success = await saveConfigToLocalStorage(newConfig);

        if (success) {
            // Обновление UI после сохранения
            renderInitialPlan();
            updateTankDisplay();
            
            closeModal();
            window.showMessage(
            "Tank-Konfiguration und Tank-Daten erfolgreich synchronisiert und lokal gespeichert!",
            "success"
          );
        }
      };

      // --- Логика Tank Details и Actions (Обновлено для localStorage) ---

      /** Обновляет модальное окно в зависимости от статуса Tank'а (без изменений) */
      window.openTankDetailsModal = function (tankId) {
        window.currentTankId = tankId;
        const tank = window.tanksData[tankId];
        const config = getTankConfigById(tankId);
        const volume = config ? config.volume : "N/A";

        if (!tank || !tank.status || !config) {
          const content =
            '<p class="text-red-600 font-semibold">Daten für diesen Tank konnten nicht geladen werden.</p>';
          openGenericModal(
            `Tank Nr.${tankId} (${volume})`,
            content,
            `<button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Schließen</button>`
          );
          return;
        }

        let htmlContent = "";
        const currentStatus = tank.status;

        const wineInfoHtml =
          tank.wineDetails &&
          (currentStatus === "full" ||
            currentStatus === "to_be_emptied" ||
            currentStatus === "reserved")
            ? `
                <div class="space-y-3 mt-4 p-4 border rounded-lg bg-gray-50">
                    <p class="text-sm font-semibold text-gray-700">Wein-Details:</p>
                    <p><span class="font-medium text-gray-600">Jahrgang:</span> ${
                      tank.wineDetails.year || "N/A"
                    }</p>
                    <p><span class="font-medium text-gray-600">Rebsorte:</span> ${
                      tank.wineDetails.variety || "N/A"
                    }</p>
                    ${
                      tank.wineDetails.addedAt
                        ? `<p class="text-xs text-gray-500 pt-2">Hinzugefügt: ${new Date(
                            tank.wineDetails.addedAt
                          ).toLocaleString("de-DE")}</p>`
                        : ""
                    }
                </div>
            `
            : "";

        let footerHtml = "";

        switch (currentStatus) {
          case "full": {
            const statusText = `<span class="text-red-600 font-bold">Gefüllt</span>`;

            const actionButton = `
                        <button onclick="markForEmptying('${tankId}')" class="w-full mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition duration-150 shadow-md">Für Entleerung vormerken (Blau)</button>
                        <button onclick="emptyTank('${tankId}')" class="w-full mt-2 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">Tank jetzt leeren (Grün)</button>
                    `;

            htmlContent = `<p class="mb-4"><span class="font-semibold">Status:</span> ${statusText}</p>${wineInfoHtml}`;
            footerHtml = `${actionButton}<button onclick="closeModal()" class="w-full mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Schließen</button>`;
            break;
          }

          case "to_be_emptied": {
            const statusText = `<span class="text-blue-600 font-bold">Wird Leer</span>`;

            const actionButton = `
                          <button onclick="undoMarkForEmptying('${tankId}')" class="w-full mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-md">Markierung Rückgängig (Rot)</button>
                          <button onclick="emptyTank('${tankId}')" class="w-full mt-2 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">Tank jetzt leeren (Grün)</button>
                        `;

            htmlContent = `<p class="mb-4"><span class="font-semibold">Status:</span> ${statusText}</p>${wineInfoHtml}`;
            footerHtml = `${actionButton}<button onclick="closeModal()" class="w-full mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Schließen</button>`;
            break;
          }

          case "empty":
          case "reserved":
            const isReserved = currentStatus === "reserved";
            let formTitle;
            let formButtons;
            let reserveButtonExternal = "";

            const currentDetails = tank.wineDetails || {};
            const prefilledYear =
              currentDetails.year || new Date().getFullYear();
            const prefilledVariety = currentDetails.variety || "";

            const formFields = `
                        <div class="mb-3">
                            <label for="wine-year" class="block text-sm font-medium text-gray-700">Jahrgang (JJJJ)</label>
                            <input type="number" id="wine-year" name="year" required min="1900" max="${new Date().getFullYear()}" value="${prefilledYear}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-3">
                            <label for="wine-variety" class="block text-sm font-medium text-gray-700">Rebsorte <span class="text-red-500">*</span></label>
                            <input type="text" id="wine-variety" name="variety" required placeholder="Z.B. Cabernet Sauvignon" value="${prefilledVariety}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    `;

            if (isReserved) {
              formTitle = `<p class="mb-4 text-yellow-700 font-bold">RESERVIERT für ${prefilledVariety}. Daten überprüfen und zum Füllen bereit.</p>`;
              formButtons = `
                            <button type="submit" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition duration-150 shadow-md text-lg" data-target-status="full">Füllen & Status auf ROT setzen</button>
                        `;
              reserveButtonExternal = `<button onclick="unreserveTank('${tankId}')" class="w-full mt-3 px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-md">Reservierung aufheben (Grün)</button>`;
            } else {
              formTitle = `<p class="mb-4 text-green-600 font-bold">Leer. Geben Sie die Weindaten ein, um den Tank zu füllen oder zu reservieren.</p>`;
              formButtons = `
                            <button type="submit" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition duration-150 shadow-md text-lg" data-target-status="full">Wein hinzufügen & füllen (Rot)</button>
                            <button type="submit" class="w-full mt-3 px-4 py-2 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition duration-150 shadow-md" data-target-status="reserved">Tank reservieren (Gelb)</button>
                        `;
            }

            htmlContent = `
                        ${formTitle}
                        <form id="wine-action-form" onsubmit="event.preventDefault(); handleWineAction(event)">
                            ${formFields}
                            ${formButtons}
                        </form>
                    `;
            footerHtml = `${reserveButtonExternal}<button onclick="closeModal()" class="w-full mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Schließen</button>`;

            break;
        }

        openGenericModal(
          `Tank Nr.${tankId} (${volume})`,
          htmlContent,
          footerHtml
        );
      };

      /** Обработчик формы для 'empty' и 'reserved' */
      window.handleWineAction = async function (event) {
        const form = event.target;
        const targetStatus = event.submitter.getAttribute("data-target-status");
        const tankId = window.currentTankId;

        if (!targetStatus || !tankId) return;

        const varietyInput = form.elements["variety"];
        if (!varietyInput.value.trim()) {
          window.showMessage("Rebsorte ist ein Pflichtfeld.", "error");
          varietyInput.focus();
          varietyInput.classList.add("config-error");
          return;
        }
        varietyInput.classList.remove("config-error");

        const wineDetails = {
          year: form.elements["year"].value || new Date().getFullYear(),
          variety: varietyInput.value.trim(),
          addedAt: new Date().toISOString(),
        };

        // ОБНОВЛЕНО: Создание копии, обновление и сохранение в localStorage
        const newData = JSON.parse(JSON.stringify(window.tanksData));
        newData[tankId].status = targetStatus;
        newData[tankId].wineDetails = wineDetails;
        window.tanksData = newData;

        const success = await saveTankDataToLocalStorage(newData);

        if (success) {
          updateTankDisplay(); // Обновление UI
          closeModal();
          window.showMessage(
            `Tank ${tankId} wurde erfolgreich als '${targetStatus}' markiert und lokal gespeichert.`,
            "success"
          );
        }
      };

      /** (Action) Пометить для опустошения (Синий) */
      window.markForEmptying = async function (tankId) {
        const newData = JSON.parse(JSON.stringify(window.tanksData));
        newData[tankId].status = "to_be_emptied";
        window.tanksData = newData;

        const success = await saveTankDataToLocalStorage(newData);
        if (success) {
          updateTankDisplay(); // Обновление UI
          closeModal();
          window.showMessage(
            `Tank ${tankId} zur Entleerung vorgemerkt (Blau) und lokal gespeichert.`,
            "info"
          );
        }
      };

      /** (Action) Отменить пометку (Красный) */
      window.undoMarkForEmptying = async function (tankId) {
        const newData = JSON.parse(JSON.stringify(window.tanksData));
        newData[tankId].status = "full";
        window.tanksData = newData;

        const success = await saveTankDataToLocalStorage(newData);
        if (success) {
          updateTankDisplay(); // Обновление UI
          closeModal();
          window.showMessage(
            `Vormerkung für Tank ${tankId} aufgehoben (Rot) und lokal gespeichert.`,
            "warning"
          );
        }
      };

      /** (Action) Опустошить Tank (Зеленый) */
      window.emptyTank = async function (tankId) {
        const newData = JSON.parse(JSON.stringify(window.tanksData));
        newData[tankId].status = "empty";
        newData[tankId].wineDetails = null;
        window.tanksData = newData;

        const success = await saveTankDataToLocalStorage(newData);
        if (success) {
          updateTankDisplay(); // Обновление UI
          closeModal();
          window.showMessage(`Tank ${tankId} wurde geleert (Grün) und lokal gespeichert.`, "success");
        }
      };

      /** (Action) Отменить резервирование (Зеленый) */
      window.unreserveTank = async function (tankId) {
        const newData = JSON.parse(JSON.stringify(window.tanksData));
        newData[tankId].status = "empty";
        newData[tankId].wineDetails = null;
        window.tanksData = newData;

        const success = await saveTankDataToLocalStorage(newData);
        if (success) {
          updateTankDisplay(); // Обновление UI
          closeModal();
          window.showMessage(
            `Reservierung für Tank ${tankId} aufgehoben (Grün) und lokal gespeichert.`,
            "success"
          );
        }
      };

      // --- Логика Обновления UI ---

      /** Обновляет стили кнопок фильтрации */
      function updateFilterButtons(activeFilter) {
        document
          .querySelectorAll("#filter-controls .filter-btn")
          .forEach((button) => {
            button.classList.remove(
              "ring-4",
              "ring-offset-2",
              "ring-gray-400",
              "ring-offset-white"
            );
          });

        const activeButton = document.getElementById(`filter-${activeFilter}`);
        if (activeButton) {
          activeButton.classList.add(
            "ring-4",
            "ring-offset-2",
            "ring-gray-400",
            "ring-offset-white"
          );
        }
      }

      /** Обновление внешнего вида Tanks'ов на плане (включая фильтрацию) */
      function updateTankDisplay() {
        // Используем tanksConfig для итерации, чтобы гарантировать правильный порядок
        window.tanksConfig.forEach((config) => {
          const id = config.id;
          const tankElement = document.querySelector(`.tank[data-id="${id}"]`);
          const data = window.tanksData[id];

          if (tankElement) {
            // Удаляем все классы статуса
            tankElement.classList.remove(
              "tank-full",
              "tank-empty",
              "tank-reserved",
              "tank-to-be-emptied",
              "config-error"
            );

            let isVisible = true;
            // Проверка, есть ли данные для этого танка. Если нет, это ошибка.
            const status = data && data.status ? data.status : "config-error"; 

            if (status !== "config-error") {
              // Применение цветового класса
              tankElement.classList.add(`tank-${status.replace(/_/g, "-")}`);
            } else {
              // Обработка ошибки конфигурации (если нет динамических данных)
              tankElement.classList.add("config-error");
            }

            // Логика фильтрации
            const isFullCategory = status === "full" || status === "reserved";
            const isEmptyCategory =
              status === "empty" || status === "to_be_emptied";

            if (window.currentFilter === "empty" && !isEmptyCategory) {
              isVisible = false;
            } else if (window.currentFilter === "full" && !isFullCategory) {
              isVisible = false;
            } else if (window.currentFilter === "all") {
              isVisible = true;
            }

            tankElement.style.display = isVisible ? "flex" : "none";

            // Обновление отображаемых ID и Volume
            tankElement.querySelector(".text-xl").textContent = id;
            tankElement.querySelector(".text-xs").textContent = config.volume;

            // Обновляем data-id для правильной обработки кликов (на случай, если ID изменился)
            tankElement.setAttribute("data-id", id);
          }
        });
        updateFilterButtons(window.currentFilter);
      }

      /** Фильтрует Tanks по статусу */
      window.filterTanks = function (filter) {
        window.currentFilter = filter;
        updateTankDisplay();
      };

      /** Первичный рендеринг плана (создание DOM-элементов) */
      function renderInitialPlan() {
        const container = document.getElementById("plan-container");
        // Собираем текущие ID элементов
        const existingIds = Array.from(container.children).map((el) =>
          el.getAttribute("data-id")
        );
        const configIds = window.tanksConfig.map((c) => c.id);

        // Удаляем элементы, которых нет в новой конфигурации
        Array.from(container.children).forEach((tankElement) => {
          const id = tankElement.getAttribute("data-id");
          if (!configIds.includes(id)) {
            tankElement.remove();
          }
        });

        // Добавляем или обновляем элементы
        window.tanksConfig.forEach((config) => {
          let tank = document.querySelector(`.tank[data-id="${config.id}"]`);

          if (!tank) {
            // Создание нового элемента
            tank = document.createElement("button");
            tank.className = "tank";
            tank.setAttribute("data-id", config.id);
            tank.onclick = () => openTankDetailsModal(config.id);

            const idSpan = document.createElement("span");
            idSpan.className = "text-xl font-bold";

            const volumeSpan = document.createElement("span");
            volumeSpan.className = "text-xs";

            tank.appendChild(idSpan);
            tank.appendChild(volumeSpan);

            container.appendChild(tank);
          }

          // Обновление содержимого (на случай, если ID или Volume изменились)
          tank.querySelector(".text-xl").textContent = config.id;
          tank.querySelector(".text-xs").textContent = config.volume;
        });
      }

      // --- Инициализация ---
      document.addEventListener("DOMContentLoaded", () => {
        setupFirebaseAndAuth(); // Теперь вызывает initializeStorageAndDisplay
        updateFilterButtons("all");
      });
    </script>
  </body>
</html>